## Архитектура Telegram-викторины

### 1. Общий обзор
- **Точки входа**:
  - `POST /webhook` — приём апдейтов Telegram.
  - `GET /health` — проверка состояния.
- **Слои**:
  - Presentation — обработка апдейтов, маршрутизация, формирование сообщений.
  - Application — игровая логика, FSM сессий, подсказки (предстоит реализовать).
  - Domain — сущности игры (пользователь, вопрос, глава) и бизнес-правила (предстоит реализовать).
  - Infrastructure — интеграции (Telegram API, БД, кэш, логирование).
- **PvP поток**:
  1. Игрок A инициирует дуэль (личное приглашение или матчмейкинг).
  2. Сервис матчей создаёт запись `duels`, фиксирует участников, статус и вопросы.
  3. Оба игрока получают синхронные вопросы; ответы сохраняются и сравниваются.
  4. По завершению подсчитываются очки, формируется итог, обновляется рейтинг.
  5. Уведомления отправляются обоим игрокам, результат фиксируется в `duel_results`.

### 2. Поток данных
1. Telegram направляет апдейт на вебхук.
2. `WebhookHandler` валидирует секрет, логирует событие, прокидывает апдейт в `UpdateRouter`.
3. `UpdateRouter` определяет тип апдейта (сообщение, callback_query, команда) и делегирует соответствующему обработчику.
4. Обработчики обращаются к сервисам приложения (на текущем этапе — заготовки отправки сообщений).
5. Состояния сессий и прогресс будут храниться в БД и кэше (следующий этап).

### 3. База данных (черновая ER-структура)
- `users` — Telegram ID, имя, настройки.
- `user_profiles` — статистика, достижения, уровни.
- `categories` — код, название, описание, сложность.
- `questions` — текст, категория, сложность, таймер, тип.
- `answers` — вариант, флаг правильности, пояснение.
- `story_chapters` — код, название, описание, порядок.
- `story_steps` — вопросы, тексты, переходы.
- `story_progress` — связь пользователя и главы, статус, очки, количество ошибок.
- `game_sessions` — активный раунд пользователя (режим, категория, текущий вопрос).
- `duels` — идентификатор матча, участники, статус, тайминги, выбранные вопросы.
- `duel_rounds` — вопросы и ответы внутри дуэли.
- `duel_results` — итоговые очки, победитель, статистика.
- `results` — история прохождений.
- `achievements` / `user_achievements` — награды.
- `admin_users`, `admin_roles`, `audit_logs`.

### 4. План расширения
- **Application layer**: сервис подсказок, таймеров, расчёта очков, менеджер сюжетных веток, обработчики состояний.
- **Domain layer**: value objects (Answer, Question, ChapterProgress), агрегаты (StoryRun).
- **Infrastructure**:
  - Eloquent модели + миграции.
  - Очереди (например, для рассылок) — через `symfony/cache` или RabbitMQ (позже).
  - Интеграция с аналитикой (Sentry/Prometheus).
- **Данные**:
  - Сидеры (`bin/seed.php`) для базовых категорий и вопросов (гарантировано 4 варианта, один правильный).
  - Импорт/экспорт контента из админ-панели (CSV/JSON).
- **Presentation**:
  - Поддержка Telegram Web Apps для расширенного UI (в будущем).
  - Локализация, шаблоны сообщений.

### 5. Админ-панель
- **Backend API**: на том же приложении, отдельные маршруты `/admin/api/*`.
- **Frontend**: SPA на Vue 3, авторизация по токену JWT, RBAC.
- **Функционал MVP**:
  - CRUD категорий, вопросов, глав.
  - Импорт/экспорт вопросов (CSV/JSON).
  - Просмотр статистики (основные метрики).

### 6. DevOps
- Окружения: `local`, `staging`, `production`.
- CI: запуск тестов, линтеров, статического анализа.
- CD: автоматическое обновление кода, прогон миграций.
- Мониторинг: логи, здоровье вебхука, производительность БД.

