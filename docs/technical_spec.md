## Техническое задание: Telegram-викторина «Путешествие знаний»

### 1. Общие сведения
- **Проект**: мобильная онлайн-викторина в формате Telegram-бота.
- **Целевая аудитория**: пользователи смартфонов, предпочитающие вертикальную ориентацию интерфейса, русскоязычные.
- **Платформа**: Telegram Bot API + вебхук.
- **Технологии**:
  - Backend: PHP ≥ 7.4 (рекомендуется 8.x), фреймворк Slim или Laravel (при возможности).
  - База данных: MySQL/MariaDB.
  - Админ-панель: веб-приложение (Vue 3 + Vite) или вторичный Telegram-бот (MVP) с возможностью перехода к веб-версии.
  - Инфраструктура: Nginx/Apache, PHP-FPM, HTTPS.

### 2. Игровая концепция
- **Режимы**:
  - Сюжетный режим: последовательность глав, объединённых нарративом «Путешествие знаний». Каждая глава содержит вступительный текст, набор вопросов, завершающую сцену.
  - Свободные раунды: пользователь выбирает категорию и количество вопросов, получает мгновенную оценку.
- **PvP-режим**:
  - Дуэль 1v1 в реальном времени: приглашение друга или подбор соперника.
  - Одновременные вопросы, система очков за скорость и правильность.
  - Таблица результатов дуэли, возможны реванш и общая статистика соперничества.
- **Категории**: история, наука, поп-культура, спорт, география, технологии (расширяемый список).
- **Механики**:
  - Таймер ответа (по умолчанию 30 секунд).
  - Подсказки (50/50, пропуск вопроса, дополнительное время), с ограничениями на использование.
  - Система очков и жизней (в сюжетном режиме – ограниченное число ошибок).
  - Достижения и рейтинги.
- **Сохранение прогресса**: складывается из текущей главы, статистики вопросов, доступных подсказок, достижений.

### 3. Функциональные требования
- **Пользователь**:
  - Запуск бота, регистрация по Telegram ID.
  - Выбор режима (сюжет / свободная игра).
  - Навигация по сюжету (продолжить текущую главу, просматривать завершённые).
  - Получение вопросов с вариантами ответов в формате inline-кнопок.
  - Получение итогов раунда, статистики, достижений.
  - Вызов другого игрока на дуэль, участие в матчах, получение результата.
  - Получение уведомлений о новых главах/событиях (опционально).
- **Администратор**:
  - Авторизация в админ-панели.
  - Управление категориями, вопросами, ответами (CRUD).
  - Настройка сюжетных глав (тексты, порядок, условия переходов).
  - Управление подсказками и наградами.
  - Просмотр статистики игроков, результатов, логов.
  - Управление правами других администраторов.
- **Система**:
  - Обработка пользовательских сообщений и команд, валидация состояний.
  - Хранение состояний сессий.
  - Генерация отчётов и логирование действий (аудит).
  - Организация матчмейкинга и синхронизация ходов в режиме дуэлей.

### 4. Нефункциональные требования
- **Производительность**: время отклика бота ≤ 1 с при средней нагрузке (до 100 запросов/с).
- **Масштабируемость**: возможность вынести задания на фоновые процессы (cron/queue).
- **Синхронность**: обработка дуэлей с задержкой не более 2 секунд между ходами.
- **Надёжность**: резервное копирование БД, устойчивость к дублирующим сообщениям.
- **Безопасность**: валидация данных, защита от повторных запросов, HTTPS для вебхука, разграничение прав.
- **UI/UX**: все тексты, кнопки и изображения — на русском. Положительные значения — зелёным, отрицательные — красным эмодзи/текстом.

### 5. Архитектура
- **Слои**:
  - API-слой для взаимодействия с Telegram (входящие апдейты, отправка сообщений).
  - Сервисный слой для игровой логики (FSM, подсказки, подсчёт очков).
  - Репозитории/ORM для доступа к БД.
  - Модуль уведомлений и аналитики.
- **Интеграции**:
  - Telegram Bot API (обязательная).
  - Sentry/аналитика (по возможности).
- **Диаграмма БД** (высокий уровень):
  - `users`, `user_profiles`
  - `categories`
  - `questions`, `answers`
  - `story_chapters`, `story_steps`, `story_progress`
  - `game_sessions`
  - `results`, `achievements`, `user_achievements`
  - `admin_users`, `admin_roles`, `audit_logs`

### 6. Roadmap MVP
1. **Аналитика и дизайн**:
   - Уточнение сюжета и контента глав.
   - Структура сообщений бота и wireframes админки.
2. **Инфраструктура**:
   - Настройка репозитория, CI/CD, окружений (dev/stage/prod).
   - Конфигурация вебхука и SSL.
3. **Бэкенд**:
   - Базовая архитектура проекта, контакты с Telegram API.
   - Модели и миграции БД.
   - Реализация FSM для сюжетного и свободного режимов.
   - Подсказки, таймеры, подсчёт очков.
4. **Админка**:
   - MVP интерфейс управления контентом.
   - Аутентификация администраторов.
5. **Контент**:
   - Наполнение базовых категорий и сюжетных глав.
6. **Тестирование**:
   - Юнит/интеграционные тесты, e2e сценарии (Telegram тестовые апдейты).
   - Нагрузочное тестирование.
7. **Запуск**:
   - Пробный релиз, сбор обратной связи.
   - Планирование расширений (WebApp, монетизация).

### 7. Риски и допущения
- Необходимость быстрого ответа Telegram → оптимизация логики и кэширование вопросов.
- Возможные ограничения по PHP 7.4 в используемых библиотеках.
- Требуется оперативное администрирование контента (желателен удобный UI).
- В будущем возможна интеграция мини-приложения (WebApp) для расширенной визуализации.

### 8. Критерии готовности MVP
- Бот развёрнут и доступен, обрабатывает команды `/start`, `/story`, `/play`.
- Пользователь может пройти минимум 3 сюжетные главы и 3 свободных раунда.
- Работают подсказки, таймер, система очков, базовые достижения.
- Админ-панель позволяет создавать/редактировать категории и вопросы.
- Все тексты локализованы, цвета значений соответствуют требованиям.
- Настроены бэкапы и логи.

